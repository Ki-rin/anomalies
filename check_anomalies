import pandas as pd
import openai

# Load the dataset
df = pd.read_csv('corporate_loans.csv')

# Set up your OpenAI API key
openai.api_key = 'your-api-key'

# Define a function to interact with the OpenAI API
def get_llm_response(prompt):
    response = openai.Completion.create(
      engine="text-davinci-003",
      prompt=prompt,
      max_tokens=150,
      n=1,
      stop=None,
      temperature=0.5,
    )
    return response.choices[0].text.strip()

# Define a function to check for anomalies using LLM
def check_anomalies_in_window(window):
    window_data = window.to_string(index=False)
    prompt = (f"Identify any anomalies or inconsistencies in the following corporate loan data rows:\n\n"
              f"{window_data}\n\n"
              "If there are anomalies, respond with the row number(s) that have anomalies; otherwise, respond 'No anomalies'.")
    response = get_llm_response(prompt)
    return response

# Define the sliding window function
def sliding_window_anomaly_detection(df, window_size=5):
    anomalies = []
    for start in range(len(df) - window_size + 1):
        window = df.iloc[start:start + window_size]
        response = check_anomalies_in_window(window)
        if response.lower() != 'no anomalies':
            # Extract row numbers from the response
            anomaly_rows = [int(num.strip()) for num in response.split() if num.isdigit()]
            anomalies.extend(window.iloc[anomaly_rows].index.tolist())
    return anomalies

# Run the sliding window anomaly detection
window_size = 5  # Adjust window size as needed
anomalies_indices = sliding_window_anomaly_detection(df, window_size=window_size)

# Extract the anomalous rows
anomalous_rows = df.loc[anomalies_indices]
print("Anomalous Rows detected by LLM:\n", anomalous_rows)

# Save the anomalous rows to a CSV file
anomalous_rows.to_csv('anomalous_rows_report.csv', index=False)
